<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="Keywords" content=""/>
    <meta name="Description" content=""/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="images/72-logo.png" type="image/x-icon">
    <title>订单列表</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/media.css">
    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="js/qrcode.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="js/main.js"></script>

</head>
<body class="md">
<header>
    <div class="header-container">
        <div class="header-left">
            <a href="index.html"><img src="images/72-logo.png" alt=""></a>
        </div>
        <div class="header-right">
            <div class="header-nav">
                <ul>
                    <li class="Tcenter"><a href="#" class="Fcolor-text-black">首页</a></li>
                    <li class="Tcenter"><a href="#" class="Fcolor-text-black">滑步车培训</a></li>
                    <li class="Tcenter"><a href="#" class="Fcolor-text-black">活动赛事</a></li>
                    <li class="Tcenter"><a href="#" class="Fcolor-text-black">官网</a></li>
                </ul>
            </div>
            <div class="header-search">
                <p><input type="text"><span class="iconfont icon-sousuo"></span></p>
            </div>
            <div class="header-user">
                <div class="user-info">
                    <div class="menu-btn-sm">
                        <span class="menu-line"></span>
                        <span class="menu-line"></span>
                        <span class="menu-line"></span>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="user-list">
        <ul>
            <li><a href="userCenter.html">个人中心</a></li>
            <li><a href="javascript:;" id="loginOut">退出</a></li>
        </ul>
    </div>
</header>
<section>
    <div class="content-container">
        <h3 class="baoming-title">个人中心</h3>
        <div class="user-content">
            <div class="user-img" id="userImg"
                 style="background-image: url(images/touxiang.jpg);-webkit-background-size: cover;background-size: cover;"></div>
            <p id="nickName"></p>
        </div>
        <div class="dingdan-content">
            <h3 class="sm-title">订单列表（<span id="dingdanCount"></span>）</h3>
            <ul id="dingdan-container">
            </ul>
        </div>
    </div>
</section>
<footer>
    <div class="bottom-info">
        <p>骑二无比网络科技有限公司</p>
        <p>本站图文是骑二无比版权盗版必究</p>
        <p>客服电话：010-80448861</p>
        <p><a href="#">使用条款</a><a href="#">隐私政策</a></p>
    </div>
</footer>
<section class="dingdan-wrapper"
         style="width: 100%;position: fixed;top: 0;margin-top: 0;height: 100%;overflow: scroll;display: none;">
    <div class="content-container" style="margin-top: 0;">
        <h3 class="baoming-title" style="margin-top: 0;">订单详情<img src="images/closeImg.png"
                                                                  style="width:20px;position:absolute;top:10px;right:5px;"
                                                                  onclick="$('.dingdan-wrapper').fadeOut(300)"/></h3>
        <div class="baoming-page tijiao-page">
            <h3 class="sm-title">订单信息</h3>
            <ul class="jichu">
                <li>订单状态：</li>
                <li><span id="dingdanStatus"></span></li>
            </ul>
            <ul class="fujia">
                <li>订单编号</li>
                <li><span id="dingdanNumber"></span></li>
            </ul>
        </div>
        <div class="user-info">
            <h3 class="sm-title">报名人信息</h3>
            <div class="info-content">
                <table class="meal-list">
                    <tbody>
                    </tbody>
                </table>
                <table>
                    <tbody>
                    <tr>
                        <td width="120">电话号码：</td>
                        <td id="dingdanPhone"></td>
                    </tr>
                    <tr>
                        <td>电子邮箱：</td>
                        <td id="dingdanEmeail"></td>
                    </tr>
                    <tr>
                        <td>备注：</td>
                        <td id="dingdanBeizhu"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="danger-info">
                <h3 class="sm-title">紧急联系人</h3>
                <table>
                    <tbody>
                    <tr>
                        <td width="120">联系人姓名：</td>
                        <td id="jinjiName"></td>
                    </tr>
                    <tr>
                        <td>联系人电话：</td>
                        <td id="jinjiPhone"></td>
                    </tr>
                    <tr>
                        <td>联系人邮箱：</td>
                        <td id="jinjiEmail"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="dingdan-btn">
            <a href="javascript:;" class="return-prev del-btn">删除订单</a>
            <a href="zhifu.html" class="tijiao-btn pay-btn">立即支付</a>
        </div>
        <p class="alert-info tel-text">若有任何问题，可拨打客服电话<br><a href="tel:010-80448861">010-80448861</a></p>
    </div>
</section>
<div class="alert-container" style="display: none;">
    <div class="alert-content">
        <h3 class="alert-title">
            提示
        </h3>
        <div class="alert-info">
            <p>
                <span style="color: #63c427;">您确认要取消订单吗？</span><br>
            </p>
        </div>
        <div class="alert-btn">
            <a href="javascript:;" class="pay-btn">确定</a>
            <a href="javascript:;" class="read-dingdan">取消</a>
        </div>
    </div>
</div>
<div class="code-container" style="display: none">
    <p class="code-header"><span class="code-title">赛事签到码</span><img src="images/closeImg.png" alt="" class="close-code" onclick="$('.code-container').fadeOut(300)"></p>
    <p style="padding: 10px 20px;">报名套餐:<span id="meal-show">两大一小(豪华酒店住宿)</span></p>
    <div class="child-group">
        <ul>
            <!--<li class="child-list">-->
                <!--<p>小孩姓名:<span>姓氏</span></p>-->
                <!--<p>出生日期:<span>2015-04-25</span></p>-->
                <!--<p>参赛组别:<span>3岁组</span></p>-->
                <!--<p>比赛时间:<span>2017-10-15 08:30</span></p>-->
            <!--</li>-->
            <!--<li class="child-list">-->
                <!--<p>小孩姓名:<span>姓氏</span></p>-->
                <!--<p>出生日期:<span>2015-04-25</span></p>-->
                <!--<p>参赛组别:<span>3岁组</span></p>-->
                <!--<p>比赛时间:<span>2017-10-15 08:30</span></p>-->
            <!--</li>-->
        </ul>
    </div>
    <p style="padding: 10px 20px;">签到状态: <span style="color: #2c9eee;" id="isSign"></span></p>
    <hr style="color: #ddd;">

    <p style="text-align:center;" class="code-text"></p>
    <div class="code-content" id="codeContent"></div>
    <p style="line-height: 30px;text-align:center;font-size: 16px;padding: 0 20px;">请向工作人员出示此码,完成签到<br>若有问题,联系客服: 80448861</p>
</div>
<script>
    $(function () {
        $.fn.isSign();//登录
        window.shareInfo = {
            url: window.location.href.split("#")[0],
            userId: window.userInfo.userId,
            orderId: "",
            activityId: "2"
        };
        $.fn.weShare(window.shareInfo);//分享相关
        $("#userImg").css("backgroundImage", "url(" + window.userInfo.userImg + ")");
        var resultData;

        function getAjaxData(url, data) {
            $.ajax({
                url: url,
                data: data,
                async: true,
                type: "post",
                dateType: "json",
                success: function (result) {
                    console.log(result);
                    console.log(data);
                    if (result.result == 1) {
                        resultData = result;
                        setResultData();
                    } else {
                        //alert("fail");
                    }
                },
                error: function (err) {
                    //alert("获取数据失败！请重新刷新网页！");
                }
            });
        }

        //展示所有订单数据
        function setResultData() {
            //展示有多少订单
            var countNum = resultData.list.length > 0 ? resultData.list.length : 0;
            $("#dingdanCount").text(resultData.list.length);
            //昵称
            $("#nickName").text(window.userInfo.name);
            var dingdanList = [];
            var statusList = ["未支付", "已支付", "已失效", "退款中", "已退款"];
            for (var i = 0; i < resultData.list.length; i++) {
                function getStatus(state, refund) {
                    if (state == 1) {//已支付
                        switch (refund) {
                            case "0": {//未进行退款
                                return 1;
                                break;
                            }
                            case "1": {//退款中
                                return 3;
                                break;
                            }
                            case "2": {//已退款
                                return 4;
                                break;
                            }
                            default: {
                                break;
                            }
                        }
                    } else if (state == 0) {//未支付
                        return 0;
                    } else if (state == 2) {//已失效
                        return 2
                    }
                }

                var nowStatus = getStatus(resultData.list[i].state, resultData.list[i].refundState);
                var temp = $("<li class=\"dingdan-list\">" +
                    "<p class=\"dingdan-title\">活动名称<span>" + (resultData.list[i].activityName == null ? "" : resultData.list[i].activityName) + "</span></p>" +
                    "<p class=\"dingdan-group\">套餐：<span>" + (resultData.list[i].comboName == null ? "" : resultData.list[i].comboName) + "</span></p>" +
                    "<p class=\"dingdan-code\">签到码：<span>" + (resultData.list[i].signCode == null ? "" : resultData.list[i].signCode) + "</span></p>" +
                    "<p class=\"dingdan-date\">报名日期：<span>" + (resultData.list[i].createDate == null ? "" : resultData.list[i].createDate) + "</span></p>" +
                    "<p class=\"dingdan-price\">金额：<span>￥" + (resultData.list[i].totalPrice == null ? "" : resultData.list[i].totalPrice) + "</span></p>" +
                    "<p class=\"dingdan-status\">状态：<span>" + statusList[nowStatus] + "</span></p>" +
                    "<p class=\"dingdan-info\">" +
                    "<a href=\"javascript:;\" class=\"sm-btn dingdan-xq\" onclick='$.fn.readMore(" + i + ")'>订单详情</a></p><p class=\"dingdan-edit\"></li>");
                switch (parseInt(nowStatus)) {
                    case 1: {//已支付
                        if (resultData.list[i].isShow) {
                            temp.append("<p class=\"dingdan-edit\"><a href=\"javascript:;\" class=\"dingdan-reload sm-btn\" onclick=\"$.fn.refundFun('" + resultData.list[i].id + "')\">申请退款</a></p>");
                        temp.append("<p class=\"dingdan-edit\"><a href=\"javascript:;\" class='sm-btn' onclick=\"$.fn.setQrCode('" +i+"')\" class=\"pay-btn\">签到码</a></p><p class=\"dingdan-edit\"><a href=\"kids.html\" class=\"pay-btn sm-btn\" style='padding: 0 10px;background:#a1cd5b;width: auto;'>最酷宝宝评选</a></p>");
                        }
                        break;
                    }
                    case 0: {//未支付
                        temp.append("<p class=\"dingdan-edit\"><a href=\"javascript:;\" class=\"dingdan-delete sm-btn\" onclick=\"$.fn.editFun('cancel','" + resultData.list[i].id + "')\">取消订单</a><a href=\"javascript:;\" class=\"dingdan-pay sm-btn\" onclick=\"$.fn.editFun('pay','" + resultData.list[i].id + "')\">立即支付</a></p>");
                        break;
                    }
                    case 2: {//已失效
                        temp.append("<p class=\"dingdan-edit\"><a href=\"javascript:;\" class=\"dingdan-reload sm-btn\" onclick=\"$.fn.editFun('rel','" + resultData.list[i].id + "')\">重新报名</a></p>");
                        break;
                    }
                    case 3: {//退款中
                        break;
                    }
                    case 4: {//已退款
                        temp.append("<p class=\"dingdan-edit\"><a href=\"javascript:;\" class=\"dingdan-reload sm-btn\" onclick=\"$.fn.editFun('rel','" + resultData.list[i].id + "')\">重新报名</a></p>");
                        break;
                    }
                    default: {
                        break;
                    }
                }
                dingdanList.push(temp);
            }
            $("#dingdan-container").append(dingdanList);
        }
        //用户退款
        $.fn.refundFun = function (id) {
            if (confirm("您是否确认要申请退款?")) {
                $.ajax({
                    url: window.userInfo.url + "activity/wechatPay/refundOrder",
                    data: {
                        orderId: id
                    },
                    dataType: "json",
                    success: function (result) {
                        if (result.result == 1) {
                            alert("退款申请成功!请您耐心等待微信商户平台处理结果!");
                            window.location.href = window.userInfo.url + "userCenter.html";
                        } else {
                            alert("退款申请失败!请重新申请");
                        }
                    },
                    error: function (error) {
                        alert("获取数据失败!请检查网络!");
                    }
                });
            } else {
                return;
            }
        };
        //编辑订单
        $.fn.editFun = function (type, id) {
            if (type == "pay") {
                //alert("支付订单");
                window.location = "http://sport.72bike.com/activity/wechatPay/getCode?orderId=" + id;
            } else if (type == "rel") {
                //alert("重新报名")
                window.location = "http://sport.72bike.com/index.html";
            } else if (type == "cancel") {
                //alert("取消订单")
                if (confirm("是否确认取消订单?")) {
                    editOrder(id);
                }
            }
        };
        //操作订单
        function editOrder(orderId) {
            $.ajax({
                url: window.userInfo.url + "activity/front/order/updateOrderState",
                data: {
                    id: orderId,
                    type: 2
                },
                type: "post",
                timeout: "20000",
                success: function (data) {
                    if (data.result == 1) {
                        alert('订单取消成功!');
                        window.location.href = window.userInfo.url + "userCenter.html"
                    } else {
                        alert("操作失败!");
                    }
                },
                error: function () {
                    alert("操作失败!请检查网络!");
                }
            })
        }

        //查看单个订单
        $.fn.readMore = function (index) {
            $(".dingdan-wrapper").fadeIn(300);
            setAdingdanData(index);
        };

        //设置查看该订单信息
        function setAdingdanData(index) {
            var statusList = ["未支付", "已支付", "已失效", "退款中", "已退款"];

            function getStatus(state, refund) {
                if (state == 1) {//已支付
                    switch (refund) {
                        case "0": {//未进行退款
                            return 1;
                            break;
                        }
                        case "1": {//退款中
                            return 3;
                            break;
                        }
                        case "2": {
                            return 4;
                            break;
                        }
                        default: {
                            break;
                        }
                    }
                } else if (state == 0) {//未支付
                    return 0;
                } else if (state == 2) {//已失效
                    return 2
                }
            }

            var nowStatus = getStatus(resultData.list[index].state, resultData.list[index].refundState);
            $("#dingdanStatus").text(statusList[nowStatus]);
            $("#dingdanNumber").text((resultData.list[index].orderNumb == null ? "" : resultData.list[index].orderNumb));

            //$("#dingdanPhone").text(resultData.list[index].telephone);
            //$("#dingdanEmeail").text(resultData.list[index].email);
            $("#dingdanBeizhu").text(resultData.list[index].remark);

            var type = ["身份证", "护照", "港澳通行证", "台湾通行证"];
            $(".user-list").remove();
            //添加联系人的信息
            for (var i = 0; i < resultData.list[index].orderUserList.length; i++) {
                var temp = $("<table class=\"user-list\"><tbody>" +
                    "<tr><td width='120'><nobr>真实姓名：</nobr></td><td>" + resultData.list[index].orderUserList[i].realname + "</td></tr>" +
                    "<tr><td>性别：</td><td>" + (resultData.list[index].orderUserList[i].sex == '0' ? '男' : '女') + "</td></tr>" +
                    "<tr><td>出生日期：</td><td>" + resultData.list[index].orderUserList[i].birthday + "</td></tr>" +
                    "<tr><td>证件类型：</td><td>" + type[resultData.list[index].orderUserList[i].documentType] + "</td></tr>" +
                    "<tr><td>证件号码：</td><td>" + resultData.list[index].orderUserList[i].documentNum + "</td></tr></tbody></table>");
                $(".info-content").prepend(temp);
                //找到有电话号码的那一条人的信息吧电话号码赋值；
                if (resultData.list[index].orderUserList[i].telephone) {
                    $("#dingdanPhone").text(resultData.list[index].orderUserList[i].telephone);
                    $("#dingdanEmeail").text(resultData.list[index].orderUserList[i].email);
                    $("#jinjiName").text(resultData.list[index].orderUserList[i].urgentUser);
                    $("#jinjiPhone").text(resultData.list[index].orderUserList[i].urgentTelephone);
                    $("#jinjiEmail").text(resultData.list[index].orderUserList[i].urgentEmail);
                }
            }
            //套餐信息
            $(".meal-list tbody").empty();
            for (var i = 0; i < resultData.list[index].comboList.length; i++) {
                if (resultData.list[index].comboList[i].count != "0") {
                    var temp = $("<tr><td  width='120'>" + (i == 0 ? '报名组别：' : '') + "</td>" +
                        "<td style=\"text-align:left;\"><span>" + resultData.list[index].comboList[i].comboName + "</span>&nbsp;&nbsp;&nbsp;&nbsp;<span></span>&nbsp;&nbsp;&nbsp;&nbsp;<span>" + resultData.list[index].comboList[i].count + "</span></td></tr>");
                    $(".meal-list tbody").append(temp);
                }
            }
            //底部按钮,根据订单状态改变需要显示的按钮
            $(".dingdan-btn").empty();
            if (nowStatus == 1) {//已支付,显示退款按钮和查看签到码按钮
                $(".dingdan-btn").removeClass("btn-group").addClass("btn-one");
                if (resultData.list[index].isShow) {
                    $(".dingdan-btn").append("<a href=\"kids.html\" class=\"pay-btn\">分享赢大奖</a><a href=\"javascript:;\" onclick=\"$.fn.refundFun('" + resultData.list[index].id + "')\" class=\"pay-btn\">申请退款</a>");
                }
            } else if (nowStatus == 0) {//未支付.显示立即支付
                $(".dingdan-btn").removeClass("btn-one").addClass("btn-group");
                $(".dingdan-btn").append("<a href=\"javascript:;\" class=\"dingdan-delete sm-btn\" onclick=\"$.fn.editFun('cancel','" + resultData.list[index].id + "')\">取消订单</a><a href=\"javascript:;\" onclick=\"$.fn.editFun('pay','" + resultData.list[index].id + "')\" class=\"pay-btn\">立即支付</a>");
            } else if (nowStatus == 2) {//已失效,显示重新报名
                $(".dingdan-btn").removeClass("btn-group").addClass("btn-one");
                $(".dingdan-btn").append("<a href=\"javascript:;\" onclick=\"$.fn.editFun('rel','" + resultData.list[index].id + "')\" class=\"pay-btn\">重新报名</a>");
            } else if (nowStatus == 3) {//退款中,显示空

            } else if (nowStatus == 4) {//已退款,显示重新报名
                $(".dingdan-btn").removeClass("btn-group").addClass("btn-one");
                $(".dingdan-btn").append("<a href=\"javascript:;\" onclick=\"$.fn.editFun('rel','" + resultData.list[index].id + "')\" class=\"pay-btn\">重新报名</a>");
            }
        }
        //新增签到码二维码
        $.fn.setQrCode = function (i) {
            var order = resultData.list[i];
            $(".code-container").fadeIn(300);
            $(".code-text").text(order.signCode);
            $(".code-container").bind("touchmove", function (ev) {
                ev.preventDefault();
            });
            $("#meal-show").text(order.comboName);//报名套餐
            //设置小孩信息
            $(".child-group ul").empty();
            for(var i = 0; i< order.length;i++){
                var temp = $("<li class=\"child-list\">" +
                    "<p>小孩姓名:<span>"+order.groups[i].realname+"</span></p>" +
                    "<p>出生日期:<span>"+order.groups[i].birthday+"</span></p>" +
                    "<p>参赛组别:<span>"+order.groups[i].groupName+"</span></p>" +
                    "<p>比赛时间:<span>"+order.groups[i].groupBeginDate+"</span></p>" +
                    "</li>");
                $(".child-group ul").append(temp);
            }
            //设置签到状态
            $("#isSign").text(order.isSign==0?"未签到":"已签到");
            //设置二维码信息
            $("#codeContent").empty();
            var qrcode = new QRCode('codeContent', {
                text: window.userInfo.url + 'manageCode.html?signCode=' + order.signCode,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        };

        function initFun() {
            getAjaxData(window.userInfo.url + "activity/front/order/selectOrder", {"userId": window.userInfo.userId});
        }
        initFun();
    });
</script>
</body>
</html>